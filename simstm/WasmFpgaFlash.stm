CALL $MAIN
FINISH

MAIN:
BEGIN_SUB
    MESSAGE 0 "TESTBENCH: WASM_FPGA_FLASH"

    CALL $WAIT_UNTIL_FLASH_LOADED

    CALL $TEST_FLASH_LOADER

    RETURN_CALL
END_SUB

WAIT_UNTIL_FLASH_LOADED:
BEGIN_SUB
    LOOP 10000 -- wait. max. 10 ms (1000ns * 10000)
        WAIT_NS 1000
        GET_SIG $WASM_SIG_FLASH_LOADED WASM_SIG_VALUE
        IF $WASM_SIG_VALUE = #x1
            EXIT_LOOP
            RETURN_CALL
        END_IF
    END_LOOP
    ERRORPRINT "ERROR: Modules are not loaded in reasonable time."
        ABORT
        RETURN_CALL
END_SUB

TEST_FLASH_LOADER:
BEGIN_SUB
    MESSAGE 0 "TEST_FLASH_LOADER"

    VERIFY_RAM 0 #x0000 MEM_VAL #xAA #xFF
    VERIFY_RAM 0 #x0001 MEM_VAL #xBB #xFF
    VERIFY_RAM 0 #x0002 MEM_VAL #xCC #xFF
    VERIFY_RAM 0 #x0003 MEM_VAL #xDD #xFF

    VERIFY_RAM 0 #x0FFA MEM_VAL #xAA #xFF
    VERIFY_RAM 0 #x0FFB MEM_VAL #xBB #xFF
    VERIFY_RAM 0 #x0FFC MEM_VAL #xCC #xFF
    VERIFY_RAM 0 #x0FFD MEM_VAL #xDD #xFF
    VERIFY_RAM 0 #x0FFE MEM_VAL #xEE #xFF
    VERIFY_RAM 0 #x0FFF MEM_VAL #x55 #xFF

    RETURN_CALL
END_SUB

INCLUDE "Defines.stm"